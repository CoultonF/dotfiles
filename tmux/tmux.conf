# tmux Configuration
# Prefix: Ctrl-a
# Sessionizer: Ctrl-g (Mac only) or Ctrl-a g (everywhere)
# Last session: Ctrl-b (Mac only) or Ctrl-a b (everywhere)
# Nested tmux: Ctrl-a Ctrl-a sends prefix to inner tmux (for DevPod)
#
# Visual distinction:
#   - Mac/Host: Blue/Sapphire accent with  icon, keyhints show C-g/C-b
#   - Container/DevPod: Mauve/Pink accent with  icon, keyhints show ^A g/^A b
#
# Note: Basic settings (terminal, mouse, base-index, history-limit, escape-time, mode-keys)
# are configured in home.nix. This file contains keybindings and theming.

# ====================
# Additional Settings
# ====================

# When a session is destroyed, switch to another session instead of exiting
set-option -g detach-on-destroy off

# Bell detection (for Claude Code notification hooks)
set -g visual-bell off        # Don't flash the whole screen
set -g bell-action other      # Alert in status bar for non-current windows
set -g monitor-bell on        # Monitor for bell in all windows

# True color support
set -ag terminal-overrides ",xterm-256color:RGB"

# Enable hyperlinks (OSC 8) passthrough for clickable URLs
set -as terminal-features ",xterm-256color:hyperlinks"

# Undercurl support (for LSP diagnostics - wavy underlines)
set -as terminal-overrides ',*:Smulx=\E[4::%p1%dm'

# Colored underlines (for diagnostic colors - red errors, yellow warnings, etc.)
set -as terminal-overrides ',*:Setulc=\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m'

# Pass terminal title (OSC 0/2) through to outer terminal (needed for blink-notify over Mosh)
set -g set-titles on
set -g set-titles-string "#{pane_title}"
set -g allow-passthrough on

# Pane base index
setw -g pane-base-index 1

# Renumber windows when one is closed
set -g renumber-windows on

# Enable focus events
set -g focus-events on

# Size windows based on the active client, not the smallest
# Options: smallest (default), largest, latest, manual
set -g window-size latest
setw -g aggressive-resize on

# ====================
# Key Bindings
# ====================

# Send prefix to nested tmux (for DevPod)
# Ctrl+A Ctrl+A sends Ctrl+A to inner tmux
bind C-a send-prefix

# Global shortcuts (no prefix) - Mac only, not in containers
# In containers, use prefix-based versions: Ctrl+A g, Ctrl+A b
if-shell '! [ -f /.dockerenv ] && [ -z "$container" ]' {
    bind -n C-g run-shell "tmux neww ~/.dotfiles/bin/tmux-sessionizer"
    bind -n C-b switch-client -l
}

# Prefix-based versions (work everywhere, including containers)
bind g run-shell "tmux neww ~/.dotfiles/bin/tmux-sessionizer"
bind b switch-client -l

# Reload config
bind r source-file ~/.config/tmux/tmux.conf \; display "Config reloaded!"

# Vim-style pane navigation
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# Splits (tmux style)
bind '"' split-window -v -c "#{pane_current_path}"
bind '%' split-window -h -c "#{pane_current_path}"
bind '|' split-window -h -c "#{pane_current_path}"
bind '-' split-window -v -c "#{pane_current_path}"

# Pane management
bind x kill-pane
bind z resize-pane -Z

# Pane resizing (hold prefix, then use capital HJKL)
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# Window/Tab management
bind c new-window -c "#{pane_current_path}"
bind , command-prompt -I "#W" "rename-window '%%'"
bind n next-window
bind p previous-window

# Quick window switching
bind 1 select-window -t 1
bind 2 select-window -t 2
bind 3 select-window -t 3
bind 4 select-window -t 4
bind 5 select-window -t 5
bind 6 select-window -t 6
bind 7 select-window -t 7
bind 8 select-window -t 8
bind 9 select-window -t 9

# Session management
bind d detach-client
bind w choose-tree -Zs

# URL picker (prefix + u)
bind u run-shell -b "~/.dotfiles/bin/tmux-url-picker"

# Copy mode (vi keys set in home.nix)
# Use -e so copy mode auto-exits when scrolling back to the bottom
bind '[' copy-mode -e

# Mouse scroll: enter copy mode with -e (auto-exit at bottom of history)
# If the app handles mouse events (e.g. vim), pass through instead
bind -n WheelUpPane if-shell -F -t = "#{mouse_any_flag}" "send-keys -M" "if -Ft= '#{pane_in_mode}' 'send-keys -M' 'copy-mode -e'"
bind -T copy-mode-vi v send -X begin-selection
# Use OSC52 for clipboard (works in containers, SSH, and locally)
# Falls back to pbcopy on Mac if OSC52 is not supported
set -g set-clipboard on
bind -T copy-mode-vi y send -X copy-pipe-and-cancel
bind -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel
bind -T copy-mode-vi Escape send -X cancel

# Vi-style navigation in copy mode
bind -T copy-mode-vi j send -X cursor-down
bind -T copy-mode-vi k send -X cursor-up
bind -T copy-mode-vi h send -X cursor-left
bind -T copy-mode-vi l send -X cursor-right
bind -T copy-mode-vi C-d send -X halfpage-down
bind -T copy-mode-vi C-u send -X halfpage-up
bind -T copy-mode-vi C-f send -X page-down
bind -T copy-mode-vi C-b send -X page-up
bind -T copy-mode-vi g send -X history-top
bind -T copy-mode-vi G send -X history-bottom

# Search in copy mode
bind -T copy-mode-vi / command-prompt -p "Search:" "send -X search-forward '%%'"
bind -T copy-mode-vi n send -X search-again
bind -T copy-mode-vi N send -X search-reverse

# ====================
# Catppuccin Mocha Theme
# ====================

# Color palette
set -g @ctp_rosewater "#f5e0dc"
set -g @ctp_flamingo "#f2cdcd"
set -g @ctp_pink "#f5c2e7"
set -g @ctp_mauve "#cba6f7"
set -g @ctp_red "#f38ba8"
set -g @ctp_maroon "#eba0ac"
set -g @ctp_peach "#fab387"
set -g @ctp_yellow "#f9e2af"
set -g @ctp_green "#a6e3a1"
set -g @ctp_teal "#94e2d5"
set -g @ctp_sky "#89dceb"
set -g @ctp_sapphire "#74c7ec"
set -g @ctp_blue "#89b4fa"
set -g @ctp_lavender "#b4befe"
set -g @ctp_text "#cdd6f4"
set -g @ctp_subtext1 "#bac2de"
set -g @ctp_subtext0 "#a6adc8"
set -g @ctp_overlay2 "#9399b2"
set -g @ctp_overlay1 "#7f849c"
set -g @ctp_overlay0 "#6c7086"
set -g @ctp_surface2 "#585b70"
set -g @ctp_surface1 "#45475a"
set -g @ctp_surface0 "#313244"
set -g @ctp_base "#1e1e2e"
set -g @ctp_mantle "#181825"
set -g @ctp_crust "#11111b"

# Status bar
set -g status on
set -g status-interval 1
set -g status-position bottom
set -g status-justify left

# Container detection for theming
# In containers: use mauve/pink accent (DevPod/remote)
# On host: use sapphire/blue accent (local Mac)
if-shell '[ -f /.dockerenv ] || [ -n "$container" ] || [ -n "$DEVPOD_WORKSPACE_ID" ]' {
    # Container theme (mauve/pink accent)
    set -g status-style "bg=#313244"
    set -g status-left "#[bg=#cba6f7,fg=#11111b,bold]  #S #[bg=#313244,fg=#cba6f7]"
    set -g status-right "#[bg=#313244,fg=#f5c2e7]#[bg=#f5c2e7,fg=#11111b,bold] ^A g #[bg=#45475a,fg=#f5c2e7] projects #[bg=#313244,fg=#45475a] #[bg=#313244,fg=#cba6f7]#[bg=#cba6f7,fg=#11111b,bold] ^A b #[bg=#45475a,fg=#cba6f7] last #[bg=#313244,fg=#45475a] #[bg=#313244,fg=#f5c2e7]#[bg=#f5c2e7,fg=#11111b] %Y-%m-%d %H:%M #[bg=#313244,fg=#f5c2e7]"
    set -g window-status-format "#{?window_bell_flag,#[bg=#313244,fg=#f38ba8]#[bg=#f38ba8,fg=#11111b,bold] #I #[bg=#45475a,fg=#f38ba8] #W #[bg=#313244,fg=#45475a],#[bg=#313244,fg=#cba6f7]#[bg=#cba6f7,fg=#11111b,bold] #I #[bg=#45475a,fg=#cba6f7] #W #[bg=#313244,fg=#45475a]}"
    set -g window-status-current-format "#[bg=#313244,fg=#f5c2e7]#[bg=#f5c2e7,fg=#11111b,bold] #I #[bg=#45475a,fg=#f5c2e7,bold] #W #[bg=#313244,fg=#45475a]"
    set -g pane-active-border-style "fg=#cba6f7"
} {
    # Host/Mac theme (sapphire/blue accent)
    set -g status-style "bg=#313244"
    set -g status-left "#[bg=#74c7ec,fg=#11111b,bold]  #S #[bg=#313244,fg=#74c7ec]"
    set -g status-right "#[bg=#313244,fg=#a6e3a1]#[bg=#a6e3a1,fg=#11111b,bold] C-g #[bg=#45475a,fg=#a6e3a1] projects #[bg=#313244,fg=#45475a] #[bg=#313244,fg=#89b4fa]#[bg=#89b4fa,fg=#11111b,bold] C-b #[bg=#45475a,fg=#89b4fa] last #[bg=#313244,fg=#45475a] #[bg=#313244,fg=#eba0ac]#[bg=#eba0ac,fg=#11111b] %Y-%m-%d %H:%M #[bg=#313244,fg=#eba0ac]"
    set -g window-status-format "#{?window_bell_flag,#[bg=#313244,fg=#f38ba8]#[bg=#f38ba8,fg=#11111b,bold] #I #[bg=#45475a,fg=#f38ba8] #W #[bg=#313244,fg=#45475a],#[bg=#313244,fg=#89b4fa]#[bg=#89b4fa,fg=#11111b,bold] #I #[bg=#45475a,fg=#89b4fa] #W #[bg=#313244,fg=#45475a]}"
    set -g window-status-current-format "#[bg=#313244,fg=#fab387]#[bg=#fab387,fg=#11111b,bold] #I #[bg=#45475a,fg=#fab387,bold] #W #[bg=#313244,fg=#45475a]"
    set -g pane-active-border-style "fg=#89b4fa"
}

# Status bar lengths
set -g status-left-length 100
set -g status-right-length 150
set -g window-status-separator " "

# Pane borders (inactive border - active is set per-theme above)
set -g pane-border-style "fg=#45475a"

# Message style
set -g message-style "bg=#313244,fg=#cdd6f4"

# Mode style (copy mode, etc.)
set -g mode-style "bg=#45475a,fg=#cdd6f4"

# Clock
set -g clock-mode-colour "#89b4fa"
