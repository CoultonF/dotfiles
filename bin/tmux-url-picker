#!/usr/bin/env bash
# tmux URL picker: extract URLs from pane, select with fzf, open or copy.
# Replaces fzf-tmux-url plugin to handle URLs that wrap across lines.

# Capture pane content, joining soft-wrapped lines (-J) and stripping escapes (no -e)
content="$(tmux capture-pane -J -p)"
joined=$(echo "$content" | tr -d '\n')

url_regex='(https?|ftp|file):/?//[-A-Za-z0-9+&@#/%?=~_|!:,.;]*[-A-Za-z0-9+&@#/%=~_|]'

# Extract from original first, then joined (newlines removed)
urls_orig=$(echo "$content" | grep -oE "$url_regex")
urls_joined=$(echo "$joined" | grep -oE "$url_regex")
urls=$(printf '%s\n%s' "$urls_orig" "$urls_joined")
wwws=$(echo "$content" | grep -oE '(https?://)?www\.[a-zA-Z](-?[a-zA-Z0-9])+\.[a-zA-Z]{2,}(/\S+)*' | grep -vE '^https?://' | sed 's/^\(.*\)$/http:\/\/\1/')
ips=$(echo "$content" | grep -oE '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}(:[0-9]{1,5})?(/\S+)*' | sed 's/^\(.*\)$/http:\/\/\1/')
gits=$(echo "$content" | grep -oE '(ssh://)?git@\S*' | sed 's/:/\//g' | sed 's/^\(ssh\/\/\/\)\{0,1\}git@\(.*\)$/https:\/\/\2/')

items=$(printf '%s\n' "${urls[@]}" "${wwws[@]}" "${ips[@]}" "${gits[@]}" |
    grep -v '^$' |
    awk '!seen[$0]++' |
    nl -w3 -s '  '
)

[ -z "$items" ] && tmux display 'No URLs found' && exit

chosen=$(fzf-tmux -w 100% -h 50% --multi -0 --no-preview --wrap <<< "$items" | awk '{print $2}')
[ -z "$chosen" ] && exit

while IFS= read -r url; do
    if [ -n "$SSH_CONNECTION" ] || [ -n "$SSH_TTY" ]; then
        if tmux set-buffer -w "$url" 2>/dev/null; then
            tmux display-message "Copied URL to clipboard"
        else
            encoded=$(printf '%s' "$url" | base64 | tr -d '\n')
            printf '\ePtmux;\e\e]52;c;%s\a\e\\' "$encoded"
            tmux display-message "Copied URL to clipboard (OSC 52)"
        fi
    else
        open "$url"
    fi
done <<< "$chosen"
